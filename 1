import pymysql
import openpyxl
import re

# 定义一个函数来清理文本数据
def clean_text(text):
    if not isinstance(text, str):
        return text
    # 使用正则表达式去除非打印字符
    text = re.sub(r'[^\x20-\x7E]', '', text)
    return text

# 数据库连接配置
config = {
    'host': 'your_host',
    'user': 'your_username',
    'password': 'your_password',
    'db': 'your_database'
}

# 创建数据库连接
connection = pymysql.connect(**config)

# 创建一个新的Excel工作簿
wb = openpyxl.Workbook()
# 删除默认创建的工作表
wb.remove(wb.active)

try:
    with connection.cursor() as cursor:
        # 获取所有表的名称
        cursor.execute("SELECT table_name FROM information_schema.tables WHERE table_schema = %s", (config['db'],))
        tables = cursor.fetchall()

        for table in tables:
            table_name = table[0]

            # 为每个表创建一个新的工作表
            ws = wb.create_sheet(title=table_name)

            # 获取每个表的字段名
            cursor.execute("SELECT column_name FROM information_schema.columns WHERE table_schema = %s AND table_name = %s", (config['db'], table_name))
            columns = [col[0] for col in cursor.fetchall()]

            # 获取每个表的最后一条数据
            cursor.execute(f"SELECT * FROM {table_name} ORDER BY id DESC LIMIT 1")
            row = cursor.fetchone()

            # 如果表为空，则跳过
            if row is None:
                continue

            # 将字段名写入第一行
            for col_num, column_name in enumerate(columns, start=1):
                ws.cell(row=1, column=col_num, value=column_name)

            # 将数据写入第二行
            for col_num, data in enumerate(row, start=1):
                try:
                    cleaned_data = clean_text(data)
                    ws.cell(row=2, column=col_num, value=cleaned_data)
                except Exception as e:
                    print(f"Error processing data for table {table_name}, column {columns[col_num-1]}: {e}")
                    # 在遇到异常时跳过当前数据项
                    continue

finally:
    connection.close()








# 保存Excel文件
output_file = 'database_last_rows.xlsx'





import pymysql

# 数据库连接配置
config = {
    'host': 'your_host',
    'user': 'your_username',
    'password': 'your_password',
    'db': 'your_database'
}

# 创建数据库连接
connection = pymysql.connect(**config)

# 用于存储每个表最后一行数据的字典
tables_data = {}

try:
    with connection.cursor() as cursor:
        # 获取所有表的名称
        cursor.execute("SELECT table_name FROM information_schema.tables WHERE table_schema = %s", (config['db'],))
        tables = cursor.fetchall()

        for table in tables:
            table_name = table[0]

            # 获取每个表的字段名
            cursor.execute("SELECT column_name FROM information_schema.columns WHERE table_schema = %s AND table_name = %s", (config['db'], table_name))
            columns = [col[0] for col in cursor.fetchall()]

            # 获取每个表的最后一条数据
            cursor.execute(f"SELECT * FROM {table_name} ORDER BY id DESC LIMIT 1")
            row = cursor.fetchone()

            # 如果表为空，则跳过
            if row is None:
                continue

            # 生成字典并添加到结果中
            row_data = dict(zip(columns, row))
            tables_data[table_name] = row_data

finally:
    connection.close()

# 打印生成的字典
for table_name, data in tables_data.items():
    print(f"Table: {table_name}")
    print(data)

